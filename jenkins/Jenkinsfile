pipeline {
    agent any
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 1, unit: 'HOURS')
    }
    
    environment {
        PYTHON_VERSION = '3'
        VENV_DIR = 'venv'
        GIT_REPO = 'https://github.com/ron1120/Devops-ci-cd-exercise.git'
    }
    
    triggers {
        githubPush()
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    sh 'echo "Checking out repository from GitHub"'
                    checkout([$class: 'GitSCM', 
                        branches: [[name: '*/main']], 
                        userRemoteConfigs: [[url: env.GIT_REPO]]
                    ])
                }
            }
        }
        
        stage('Setup Environment') {
            steps {
                script {
                    sh 'echo "Setting up Python environment"'
                    
                    sh 'python${PYTHON_VERSION} -m venv ${VENV_DIR}'
                    sh '. ${VENV_DIR}/bin/activate && pip install --upgrade pip'
                    sh '. ${VENV_DIR}/bin/activate && pip install -r requirements.txt'
                }
            }
        }
        
        stage('Lint Code') {
            steps {
                script {
                    sh '. ${VENV_DIR}/bin/activate && flake8 app/ --output-file=reports/flake8.txt || true'
                    sh '. ${VENV_DIR}/bin/activate && pylint app/ --output=reports/pylint.txt || true'
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'reports/*.txt', allowEmptyArchive: true
                }
            }
        }
        
        stage('Unit Tests') {
            steps {
                script {
                    sh 'mkdir -p reports htmlcov'
                    sh '. ${VENV_DIR}/bin/activate && pytest tests/unit/ -v --cov=app --cov-report=html:htmlcov --cov-report=xml:reports/coverage.xml --cov-report=term-missing --junit-xml=reports/unit-tests.xml'
                }
            }
            post {
                always {
                    junit 'reports/unit-tests.xml'
                    archiveArtifacts artifacts: 'htmlcov/**/*,reports/unit-tests.xml,reports/coverage.xml', allowEmptyArchive: false
                }
            }
        }
        
        stage('Integration Tests') {
            steps {
                script {
                    sh '. ${VENV_DIR}/bin/activate && pytest tests/integration/ -v --junit-xml=reports/integration-tests.xml || true'
                }
            }
            post {
                always {
                    junit 'reports/integration-tests.xml'
                    archiveArtifacts artifacts: 'reports/integration-tests.xml', allowEmptyArchive: true
                }
            }
        }
        
        stage('End-to-End Tests') {
            steps {
                script {
                    sh '. ${VENV_DIR}/bin/activate && pytest tests/e2e/ -v --junit-xml=reports/e2e-tests.xml || true'
                }
            }
            post {
                always {
                    junit 'reports/e2e-tests.xml'
                    archiveArtifacts artifacts: 'reports/e2e-tests.xml', allowEmptyArchive: true
                }
            }
        }
        
        stage('Performance Tests') {
            when {
                expression {
                    env.GIT_BRANCH == 'origin/production' || env.BRANCH_NAME == 'production'
                }
            }
            steps {
                script {
                    sh '''
                        . ${VENV_DIR}/bin/activate
                        
                        python main.py &
                        APP_PID=$!
                        sleep 5
                        
                        locust -f tests/performance/locustfile.py \\
                            --headless \\
                            --users 10 \\
                            --spawn-rate 2 \\
                            --run-time 30s \\
                            --host http://localhost:5000 \\
                            --html reports/performance-report.html || true
                        
                        kill $APP_PID || true
                    '''
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'reports/performance-report.html', allowEmptyArchive: true
                }
            }
        }
        
        stage('Security Scan') {
            steps {
                script {
                    sh '. ${VENV_DIR}/bin/activate && bandit -r app/ -f json -o reports/bandit-report.json || true'
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'reports/bandit-report.json', allowEmptyArchive: true
                }
            }
        }
        
        stage('Create Version Tag') {
            when {
                expression {
                    env.GIT_BRANCH == 'origin/main' || env.GIT_BRANCH == 'origin/develop' || env.BRANCH_NAME == 'main' || env.BRANCH_NAME == 'develop'
                }
            }
            steps {
                script {
                    sh '''
                        git config user.email "jenkins@example.com"
                        git config user.name "Jenkins CI"
                        VERSION=$(date +%Y.%m.%d.%H%M%S)
                        git tag -a v$VERSION -m "Release version $VERSION" || true
                        git push origin v$VERSION || true
                        echo "VERSION=$VERSION" > version.txt
                    '''
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'version.txt', allowEmptyArchive: true
                }
            }
        }
        
        stage('Build Docker Image') {
            when {
                expression {
                    env.GIT_BRANCH == 'origin/main' || env.GIT_BRANCH == 'origin/develop' || env.BRANCH_NAME == 'main' || env.BRANCH_NAME == 'develop'
                }
            }
            steps {
                script {
                    sh '''
                        if [ -f version.txt ]; then
                            VERSION=$(cat version.txt | cut -d= -f2)
                        else
                            VERSION=${BUILD_NUMBER}
                        fi
                        
                        docker build -t devops-testing-app:${VERSION} -f docker/Dockerfile .
                        docker tag devops-testing-app:${VERSION} devops-testing-app:latest
                        echo "Docker image built: devops-testing-app:${VERSION}"
                    '''
                }
            }
        }
        
        stage('Deploy to Staging') {
            when {
                expression {
                    env.GIT_BRANCH == 'origin/develop' || env.BRANCH_NAME == 'develop'
                }
            }
            steps {
                script {
                    sh '''
                        if [ -f version.txt ]; then
                            VERSION=$(cat version.txt | cut -d= -f2)
                        else
                            VERSION=${BUILD_NUMBER}
                        fi
                        
                        echo "Deploying to staging environment"
                        docker stop staging-app || true
                        docker rm staging-app || true
                        docker run -d --name staging-app -p 5001:5000 devops-testing-app:${VERSION}
                        
                        sleep 5
                        curl -f http://localhost:5001/health || exit 1
                    '''
                }
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
        success {
            script {
                sh 'echo "Pipeline completed successfully!"'
                emailext (
                    subject: "✅ Pipeline Success: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                    body: """
                        <p>The pipeline completed successfully!</p>
                        <ul>
                            <li><strong>Build:</strong> ${env.BUILD_NUMBER}</li>
                            <li><strong>Branch:</strong> ${env.BRANCH_NAME}</li>
                            <li><strong>Duration:</strong> ${currentBuild.durationString}</li>
                            <li><strong>Reports:</strong> Check the artifacts section</li>
                        </ul>
                        <p><a href="${env.BUILD_URL}">View Build Details</a></p>
                    """,
                    to: "${env.CHANGE_AUTHOR_EMAIL}"
                )
            }
        }
        failure {
            script {
                sh 'echo "Pipeline failed!"'
                emailext (
                    subject: "❌ Pipeline Failure: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                    body: """
                        <p>The pipeline failed!</p>
                        <ul>
                            <li><strong>Build:</strong> ${env.BUILD_NUMBER}</li>
                            <li><strong>Branch:</strong> ${env.BRANCH_NAME}</li>
                            <li><strong>Duration:</strong> ${currentBuild.durationString}</li>
                            <li><strong>Failed Stage:</strong> ${currentBuild.currentResult}</li>
                        </ul>
                        <p><a href="${env.BUILD_URL}">View Build Details</a></p>
                    """,
                    to: "${env.CHANGE_AUTHOR_EMAIL}"
                )
            }
        }
    }
}