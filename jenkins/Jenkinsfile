// =============================================================================
// CI/CD Pipeline â€” Checkout â†’ Lint â†’ Test â†’ Security â†’ Docker â†’ Deploy (AWS)
// =============================================================================

pipeline {
    agent any

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 1, unit: 'HOURS')
    }

    environment {
        PYTHON_VERSION = '3'
        VENV_DIR       = 'venv'
        GIT_REPO       = 'https://github.com/ron1120/Devops-ci-cd-exercise.git'
    }

    triggers { githubPush() }

    stages {

        // â”€â”€ 1. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Checkout') {
            steps {
                script {
                    git branch: 'main', credentialsId: 'RonGitUser', url: env.GIT_REPO

                    env.GIT_BRANCH_NAME = sh(
                        script: 'git rev-parse --abbrev-ref HEAD || echo main',
                        returnStdout: true
                    ).trim()

                    if (env.GIT_BRANCH_NAME == 'HEAD') { env.GIT_BRANCH_NAME = 'main' }
                    echo "Branch: ${env.GIT_BRANCH_NAME}"
                }
            }
        }
        
        // â”€â”€ 2. Setup Environment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Setup Environment') {
            steps {
                sh '''
                    if command -v python3 >/dev/null 2>&1; then
                        python${PYTHON_VERSION} -m venv ${VENV_DIR}
                        . ${VENV_DIR}/bin/activate && pip install --upgrade pip
                        . ${VENV_DIR}/bin/activate && pip install -r requirements.txt

                    elif command -v docker >/dev/null 2>&1 && docker info >/dev/null 2>&1; then
                        docker run --rm -v "$PWD":/workspace -w /workspace python:3.11-slim bash -c \
                            "python${PYTHON_VERSION} -m venv ${VENV_DIR} \
                             && . ${VENV_DIR}/bin/activate \
                             && pip install --upgrade pip \
                             && pip install -r requirements.txt"
                    else
                        echo "No python3 or Docker available"; exit 1
                    fi
                '''
            }
        }
        
        // â”€â”€ 3. Lint Code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Lint Code') {
            steps {
                sh '''
                    mkdir -p reports

                    if command -v python3 >/dev/null 2>&1; then
                        . ${VENV_DIR}/bin/activate
                        flake8 app/ --format=default --output-file=reports/flake8.txt || true
                        pylint app/ --output=reports/pylint.txt || true

                    elif command -v docker >/dev/null 2>&1 && docker info >/dev/null 2>&1; then
                        docker run --rm -v "$PWD":/workspace -w /workspace python:3.11-slim bash -c \
                            "pip install --no-cache-dir -r requirements.txt \
                             && flake8 app/ --format=default --output-file=reports/flake8.txt || true \
                             && pylint app/ --output=reports/pylint.txt || true"
                    else
                        echo "Cannot run linters"; exit 1
                    fi

                    # Wrap plain-text lint reports in HTML for sidebar display
                    for f in flake8 pylint; do
                        echo "<html><head><title>${f} Report</title></head><body><pre>" > reports/${f}-report.html
                        cat reports/${f}.txt >> reports/${f}-report.html 2>/dev/null || echo "No output" >> reports/${f}-report.html
                        echo "</pre></body></html>" >> reports/${f}-report.html
                    done
                '''
            }
            post {
                always {
                    archiveArtifacts artifacts: 'reports/flake8*, reports/pylint*', allowEmptyArchive: true
                    publishHTML(target: [
                        reportName: 'Flake8 Report',
                        reportDir: 'reports',
                        reportFiles: 'flake8-report.html',
                        keepAll: true,
                        alwaysLinkToLastBuild: true,
                        allowMissing: true
                    ])
                    publishHTML(target: [
                        reportName: 'Pylint Report',
                        reportDir: 'reports',
                        reportFiles: 'pylint-report.html',
                        keepAll: true,
                        alwaysLinkToLastBuild: true,
                        allowMissing: true
                    ])
                }
            }
        }
        
        // â”€â”€ 4. Unit Tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Unit Tests') {
            steps {
                sh '''
                    mkdir -p reports htmlcov
                    PYTEST_ARGS="tests/unit/ -v \
                        --cov=app \
                        --cov-report=html:htmlcov \
                        --cov-report=xml:reports/coverage.xml \
                        --cov-report=term-missing \
                        --junit-xml=reports/unit-tests.xml"

                    if command -v python3 >/dev/null 2>&1; then
                        . ${VENV_DIR}/bin/activate && pytest ${PYTEST_ARGS}

                    elif command -v docker >/dev/null 2>&1 && docker info >/dev/null 2>&1; then
                        docker run --rm -v "$PWD":/workspace -w /workspace python:3.11-slim bash -c \
                            "pip install --no-cache-dir -r requirements.txt && pytest ${PYTEST_ARGS}"
                    else
                        echo "Cannot run unit tests"; exit 1
                    fi
                '''
            }
            post {
                always {
                    junit 'reports/unit-tests.xml'
                    archiveArtifacts artifacts: 'htmlcov/**/*,reports/unit-tests.xml,reports/coverage.xml',
                                     allowEmptyArchive: false
                    publishHTML(target: [
                        reportName: 'Coverage Report',
                        reportDir: 'htmlcov',
                        reportFiles: 'index.html',
                        keepAll: true,
                        alwaysLinkToLastBuild: true,
                        allowMissing: true
                    ])
                }
            }
        }
        
        // â”€â”€ 5. Integration Tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Integration Tests') {
            steps {
                sh '''
                    mkdir -p reports
                    if command -v python3 >/dev/null 2>&1; then
                        . ${VENV_DIR}/bin/activate
                        pytest tests/integration/ -v --junit-xml=reports/integration-tests.xml || true

                    elif command -v docker >/dev/null 2>&1 && docker info >/dev/null 2>&1; then
                        docker run --rm -v "$PWD":/workspace -w /workspace python:3.11-slim bash -c \
                            "pip install --no-cache-dir -r requirements.txt \
                             && pytest tests/integration/ -v --junit-xml=reports/integration-tests.xml || true"
                    else
                        echo "Cannot run integration tests"; exit 1
                    fi
                '''
            }
            post {
                always {
                    junit 'reports/integration-tests.xml'
                    archiveArtifacts artifacts: 'reports/integration-tests.xml', allowEmptyArchive: true
                }
            }
        }
        
        // â”€â”€ 6. End-to-End Tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('End-to-End Tests') {
            steps {
                sh '''
                    mkdir -p reports
                    if command -v python3 >/dev/null 2>&1; then
                        . ${VENV_DIR}/bin/activate
                        pytest tests/e2e/ -v --junit-xml=reports/e2e-tests.xml || true

                    elif command -v docker >/dev/null 2>&1 && docker info >/dev/null 2>&1; then
                        docker run --rm -v "$PWD":/workspace -w /workspace python:3.11-slim bash -c \
                            "pip install --no-cache-dir -r requirements.txt \
                             && pytest tests/e2e/ -v --junit-xml=reports/e2e-tests.xml || true"
                    else
                        echo "Cannot run E2E tests"; exit 1
                    fi
                '''
            }
            post {
                always {
                    junit 'reports/e2e-tests.xml'
                    archiveArtifacts artifacts: 'reports/e2e-tests.xml', allowEmptyArchive: true
                }
            }
        }
        
        // â”€â”€ 7. Security Scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Security Scan') {
            steps {
                sh '''
                    mkdir -p reports
                    if command -v python3 >/dev/null 2>&1; then
                        . ${VENV_DIR}/bin/activate
                        bandit -r app/ -f json -o reports/bandit-report.json || true
                        bandit -r app/ -f html -o reports/bandit-report.html || true

                    elif command -v docker >/dev/null 2>&1 && docker info >/dev/null 2>&1; then
                        docker run --rm -v "$PWD":/workspace -w /workspace python:3.11-slim bash -c \
                            "pip install --no-cache-dir -r requirements.txt \
                             && bandit -r app/ -f json -o reports/bandit-report.json || true \
                             && bandit -r app/ -f html -o reports/bandit-report.html || true"
                    else
                        echo "Cannot run security scan"; exit 1
                    fi
                '''
            }
            post {
                always {
                    archiveArtifacts artifacts: 'reports/bandit-report.*', allowEmptyArchive: true
                    publishHTML(target: [
                        reportName: 'Security Report (Bandit)',
                        reportDir: 'reports',
                        reportFiles: 'bandit-report.html',
                        keepAll: true,
                        alwaysLinkToLastBuild: true,
                        allowMissing: true
                    ])
                }
            }
        }
        
        // â”€â”€ 8. Create Version Tag (main/develop) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Create Version Tag') {
            when { expression { return env.GIT_BRANCH_NAME in ['main', 'develop'] } }
            steps {
                withCredentials([usernamePassword(credentialsId: 'RonGitUser', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
                    sh '''
                        git config user.email "jenkins@example.com"
                        git config user.name  "Jenkins CI"
                        VERSION=$(date +%Y.%m.%d.%H%M%S)
                        git tag -a v$VERSION -m "Release version $VERSION" || true
                        echo "VERSION=$VERSION" > version.txt
                        echo "âœ“ Version tag: v$VERSION"
                    '''
                }
            }
            post {
                always { archiveArtifacts artifacts: 'version.txt', allowEmptyArchive: true }
            }
        }
        
        // â”€â”€ 9. Build Docker Image (main/develop) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Build Docker Image') {
            when { expression { return env.GIT_BRANCH_NAME in ['main', 'develop'] } }
            steps {
                sh '''
                    if ! command -v docker >/dev/null 2>&1 || ! docker info >/dev/null 2>&1; then
                        echo "âš  Docker not available â€” skipping build"; exit 0
                    fi

                    VERSION=$(cut -d= -f2 version.txt 2>/dev/null || echo ${BUILD_NUMBER})

                    echo "Building devops-testing-app:${VERSION} (linux/amd64)"
                    docker buildx create --use --name multiarch >/dev/null 2>&1 || true
                    docker buildx build --platform linux/amd64 \
                        -t devops-testing-app:${VERSION} \
                        -f docker/Dockerfile --load .
                    docker tag devops-testing-app:${VERSION} devops-testing-app:latest
                    echo "âœ“ Built: devops-testing-app:${VERSION}"
                '''
            }
        }

        // â”€â”€ 10. Push Docker Image (main/develop) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Push Docker Image') {
            when { expression { return env.GIT_BRANCH_NAME in ['main', 'develop'] } }
            steps {
                withCredentials([usernamePassword(credentialsId: 'RonDockerUser', usernameVariable: 'DOCKERHUB_USER', passwordVariable: 'DOCKERHUB_PASS')]) {
                    sh '''
                        if ! command -v docker >/dev/null 2>&1 || ! docker info >/dev/null 2>&1; then
                            echo "âš  Docker not available â€” skipping push"; exit 0
                        fi

                        VERSION=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/^v//' \
                            || cut -d= -f2 version.txt 2>/dev/null \
                            || echo "${BUILD_NUMBER}")
                        [ -z "$VERSION" ] && VERSION=${BUILD_NUMBER}

                        echo "Pushing devops-testing-app:${VERSION}"
                        echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USER" --password-stdin

                        if docker image inspect devops-testing-app:${VERSION} >/dev/null 2>&1; then
                            docker tag devops-testing-app:${VERSION} ${DOCKERHUB_USER}/devops-testing-app:${VERSION}
                            docker tag devops-testing-app:${VERSION} ${DOCKERHUB_USER}/devops-testing-app:latest
                            docker push ${DOCKERHUB_USER}/devops-testing-app:${VERSION}
                            docker push ${DOCKERHUB_USER}/devops-testing-app:latest
                            echo "âœ“ Pushed: ${DOCKERHUB_USER}/devops-testing-app:${VERSION}"
                        else
                            echo "âš  Image not found locally â€” skipping push"
                        fi

                        docker logout || true
                    '''
                }
            }
        }
        
        // â”€â”€ 11. Deploy to Staging (main/develop) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Deploy to Staging') {
            when { expression { return env.GIT_BRANCH_NAME in ['main', 'develop'] } }
            stages {

                stage('Terraform Init & Plan') {
                    steps {
                        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-credentials',
                                          accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
                            sh '''
                                export AWS_DEFAULT_REGION="us-east-2"
                                cd infrastructure/terraform

                                VERSION=$(cut -d= -f2 ../../version.txt 2>/dev/null || echo "${BUILD_NUMBER}")
                                DOCKER_IMAGE="ronsss/devops-testing-app:${VERSION}"
                                echo "Image: ${DOCKER_IMAGE}"

                                terraform init -input=false
                                terraform plan -var="docker_image=${DOCKER_IMAGE}" -out=tfplan -input=false
                                echo "âœ… Terraform plan created"
                            '''
                        }
                    }
                }

                stage('Terraform Apply') {
                    steps {
                        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-credentials',
                                          accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
                            sh '''
                                export AWS_DEFAULT_REGION="us-east-2"
                                cd infrastructure/terraform
                                terraform apply -auto-approve -input=false tfplan
                                terraform output -json > ../../terraform_outputs.json
                                terraform output
                                echo "âœ… Infrastructure provisioned"
                            '''
                        }
                    }
                }

                stage('Ansible Deploy') {
                    steps {
                        withCredentials([
                            [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-credentials',
                             accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'],
                            sshUserPrivateKey(credentialsId: 'StagingSSHKey', keyFileVariable: 'SSH_KEY_FILE'),
                            usernamePassword(credentialsId: 'RonDockerUser', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')
                        ]) {
                            sh '''
                                VERSION=$(cut -d= -f2 version.txt 2>/dev/null || echo "${BUILD_NUMBER}")
                                DOCKER_IMAGE="ronsss/devops-testing-app:${VERSION}"

                                STAGING_IP=$(python3 -c "import json; print(json.load(open('terraform_outputs.json'))['instance_public_ip']['value'])")
                                echo "Staging IP: ${STAGING_IP}"

                                # Generate dynamic inventory
                                cat > infrastructure/ansible/inventory.ini <<INVENTORY_EOF
[staging]
${STAGING_IP} ansible_user=ec2-user ansible_ssh_private_key_file=${SSH_KEY_FILE}
INVENTORY_EOF

                                # Wait for SSH
                                echo "Waiting for SSH on ${STAGING_IP}..."
                                for i in $(seq 1 30); do
                                    if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
                                           -i "${SSH_KEY_FILE}" ec2-user@${STAGING_IP} \
                                           "echo ready" >/dev/null 2>&1; then
                                        echo "âœ“ SSH ready"; break
                                    fi
                                    echo "  Attempt $i/30 â€” waiting 10s..."
                                    sleep 10
                                done

                                [ -d /opt/venv ] && . /opt/venv/bin/activate

                                ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook \
                                    -i infrastructure/ansible/inventory.ini \
                                    infrastructure/ansible/deploy.yml \
                                    -e "docker_image=${DOCKER_IMAGE}" \
                                    -e "app_port=5000" \
                                    -e "docker_hub_user=${DOCKER_USER}" \
                                    -e "docker_hub_pass=${DOCKER_PASS}" \
                                    -v

                                echo "âœ… Deployed: http://${STAGING_IP}:5000"
                            '''
                        }
                    }
                }

                stage('Smoke Test') {
                    steps {
                        sh '''
                            STAGING_IP=$(python3 -c "import json; print(json.load(open('terraform_outputs.json'))['instance_public_ip']['value'])")
                            echo "Smoke testing http://${STAGING_IP}:5000"

                            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "http://${STAGING_IP}:5000/health")
                            if [ "$HTTP_STATUS" = "200" ]; then
                                echo "âœ… Health check passed (HTTP ${HTTP_STATUS})"
                            else
                                echo "âŒ Health check failed (HTTP ${HTTP_STATUS})"; exit 1
                            fi

                            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "http://${STAGING_IP}:5000/")
                            if [ "$HTTP_STATUS" = "200" ]; then
                                echo "âœ… Homepage accessible (HTTP ${HTTP_STATUS})"
                            else
                                echo "âš   Homepage returned HTTP ${HTTP_STATUS}"
                            fi

                            echo "âœ… Smoke tests passed â€” http://${STAGING_IP}:5000"
                        '''
                    }
                }

                stage('Performance Tests') {
                    steps {
                        sh '''
                            mkdir -p reports
                            STAGING_IP=$(python3 -c "import json; print(json.load(open('terraform_outputs.json'))['instance_public_ip']['value'])")
                            echo "ğŸš€ Running performance test against http://${STAGING_IP}:5000"

                            LOCUST_ARGS="-f tests/performance/locustfile.py --headless \
                                --users 10 --spawn-rate 2 --run-time 30s \
                                --host http://${STAGING_IP}:5000 \
                                --html reports/performance-report.html"

                            if command -v python3 >/dev/null 2>&1; then
                                . ${VENV_DIR}/bin/activate
                                locust ${LOCUST_ARGS} || true

                            elif command -v docker >/dev/null 2>&1 && docker info >/dev/null 2>&1; then
                                docker run --rm -v "$PWD":/workspace -w /workspace python:3.11-slim bash -c \
                                    "pip install --no-cache-dir -r requirements.txt \
                                     && locust ${LOCUST_ARGS} || true"
                            else
                                echo "Cannot run performance tests"; exit 1
                            fi
                        '''
                    }
                    post {
                        always {
                            archiveArtifacts artifacts: 'reports/performance-report.html', allowEmptyArchive: true
                            publishHTML(target: [
                                reportName: 'Performance Report',
                                reportDir: 'reports',
                                reportFiles: 'performance-report.html',
                                keepAll: true,
                                alwaysLinkToLastBuild: true,
                                allowMissing: true
                            ])
                        }
                    }
                }
            }
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  POST-BUILD: Email + Jira
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    post {
        always { cleanWs() }

        // â”€â”€ Success â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        success {
            script {
                emailext(
                    subject: "âœ… Pipeline Success: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                    to: 'whtestore@gmail.com', mimeType: 'text/html',
                    body: """
                        <h2 style="color:green;">âœ… Pipeline Completed Successfully</h2>
                        <table style="border-collapse:collapse; width:100%; max-width:600px;">
                            <tr><td style="padding:8px; border:1px solid #ddd;"><b>Build</b></td><td style="padding:8px; border:1px solid #ddd;">#${env.BUILD_NUMBER}</td></tr>
                            <tr><td style="padding:8px; border:1px solid #ddd;"><b>Branch</b></td><td style="padding:8px; border:1px solid #ddd;">${env.GIT_BRANCH_NAME ?: 'main'}</td></tr>
                            <tr><td style="padding:8px; border:1px solid #ddd;"><b>Duration</b></td><td style="padding:8px; border:1px solid #ddd;">${currentBuild.durationString}</td></tr>
                            <tr><td style="padding:8px; border:1px solid #ddd;"><b>Status</b></td><td style="padding:8px; border:1px solid #ddd; color:green;"><b>SUCCESS</b></td></tr>
                        </table>
                        <p>ğŸ“ <a href="${env.BUILD_URL}artifact/">Artifacts</a> | ğŸ”— <a href="${env.BUILD_URL}">Details</a></p>
                    """
                )
            }
        }

        // â”€â”€ Unstable â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        unstable {
            script {
                def failedStageText = 'Test stage(s) had failures'
                emailext(
                    subject: "âš ï¸ Pipeline Unstable: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                    to: 'whtestore@gmail.com', mimeType: 'text/html',
                    body: """
                        <h2 style="color:orange;">âš ï¸ Pipeline Finished Unstable</h2>
                        <table style="border-collapse:collapse; width:100%; max-width:600px;">
                            <tr><td style="padding:8px; border:1px solid #ddd;"><b>Build</b></td><td style="padding:8px; border:1px solid #ddd;">#${env.BUILD_NUMBER}</td></tr>
                            <tr><td style="padding:8px; border:1px solid #ddd;"><b>Branch</b></td><td style="padding:8px; border:1px solid #ddd;">${env.GIT_BRANCH_NAME ?: 'main'}</td></tr>
                            <tr><td style="padding:8px; border:1px solid #ddd;"><b>Duration</b></td><td style="padding:8px; border:1px solid #ddd;">${currentBuild.durationString}</td></tr>
                            <tr><td style="padding:8px; border:1px solid #ddd;"><b>Issue</b></td><td style="padding:8px; border:1px solid #ddd; color:orange;">${failedStageText}</td></tr>
                            <tr><td style="padding:8px; border:1px solid #ddd;"><b>Status</b></td><td style="padding:8px; border:1px solid #ddd; color:orange;"><b>UNSTABLE</b></td></tr>
                        </table>
                        <p>ğŸ§ª <a href="${env.BUILD_URL}testReport/">Tests</a> | ğŸ”— <a href="${env.BUILD_URL}">Details</a></p>
                    """
                )
                // Jira ticket â€” Medium priority
                withCredentials([string(credentialsId: 'JIRA_API_TOKEN', variable: 'JIRA_TOKEN')]) {
                    sh '''
                        RESPONSE=$(curl -s -w "\\n%{http_code}" -X POST \
                            "https://ron1120.atlassian.net/rest/api/3/issue" \
                            -H "Content-Type: application/json" \
                            -u "ronss1120@gmail.com:${JIRA_TOKEN}" \
                            -d '{"fields":{"project":{"key":"KAN"},"issuetype":{"name":"Task"},"priority":{"name":"Medium"},
                                "summary":"âš ï¸ Pipeline Unstable: Build #'"${BUILD_NUMBER}"' ('"${JOB_NAME}"')",
                                "description":{"type":"doc","version":1,"content":[{"type":"paragraph","content":[
                                    {"type":"text","text":"Pipeline unstable (test failures)."},
                                    {"type":"hardBreak"},{"type":"text","text":"Job: '"${JOB_NAME}"'"},
                                    {"type":"hardBreak"},{"type":"text","text":"Build: #'"${BUILD_NUMBER}"'"},
                                    {"type":"hardBreak"},{"type":"text","text":"Branch: '"${GIT_BRANCH_NAME:-main}"'"},
                                    {"type":"hardBreak"},{"type":"text","text":"URL: '"${BUILD_URL}"'"}]}]}}}')

                        HTTP_CODE=$(echo "$RESPONSE" | tail -1)
                        BODY=$(echo "$RESPONSE" | head -n -1)
                        if [ "$HTTP_CODE" = "201" ]; then
                            TICKET=$(echo "$BODY" | python3 -c "import sys,json; print(json.load(sys.stdin)['key'])" 2>/dev/null)
                            echo "âœ… Jira: ${TICKET} â†’ https://ron1120.atlassian.net/browse/${TICKET}"
                        else
                            echo "âš  Jira failed (HTTP ${HTTP_CODE}): $BODY"
                        fi
                    '''
                }
            }
        }

        // â”€â”€ Failure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        failure {
            script {
                def failedStageName = env.STAGE_NAME ?: 'Unknown'
                emailext(
                    subject: "âŒ Pipeline FAILED: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                    to: 'whtestore@gmail.com', mimeType: 'text/html',
                    body: """
                        <h2 style="color:red;">âŒ Pipeline Failed</h2>
                        <table style="border-collapse:collapse; width:100%; max-width:600px;">
                            <tr><td style="padding:8px; border:1px solid #ddd;"><b>Build</b></td><td style="padding:8px; border:1px solid #ddd;">#${env.BUILD_NUMBER}</td></tr>
                            <tr><td style="padding:8px; border:1px solid #ddd;"><b>Branch</b></td><td style="padding:8px; border:1px solid #ddd;">${env.GIT_BRANCH_NAME ?: 'main'}</td></tr>
                            <tr><td style="padding:8px; border:1px solid #ddd;"><b>Duration</b></td><td style="padding:8px; border:1px solid #ddd;">${currentBuild.durationString}</td></tr>
                            <tr><td style="padding:8px; border:1px solid #ddd;"><b>Failed Stage</b></td><td style="padding:8px; border:1px solid #ddd; color:red;">${failedStageName}</td></tr>
                            <tr><td style="padding:8px; border:1px solid #ddd;"><b>Status</b></td><td style="padding:8px; border:1px solid #ddd; color:red;"><b>FAILURE</b></td></tr>
                        </table>
                        <p>ğŸ“‹ <a href="${env.BUILD_URL}console">Console</a> | ğŸ”— <a href="${env.BUILD_URL}">Details</a></p>
                    """
                )
                // Jira ticket â€” High priority
                withCredentials([string(credentialsId: 'JIRA_API_TOKEN', variable: 'JIRA_TOKEN')]) {
                    sh '''
                        RESPONSE=$(curl -s -w "\\n%{http_code}" -X POST \
                            "https://ron1120.atlassian.net/rest/api/3/issue" \
                            -H "Content-Type: application/json" \
                            -u "ronss1120@gmail.com:${JIRA_TOKEN}" \
                            -d '{"fields":{"project":{"key":"KAN"},"issuetype":{"name":"Task"},"priority":{"name":"High"},
                                "summary":"âŒ Pipeline Failed: Build #'"${BUILD_NUMBER}"' ('"${JOB_NAME}"')",
                                "description":{"type":"doc","version":1,"content":[{"type":"paragraph","content":[
                                    {"type":"text","text":"Pipeline failed."},
                                    {"type":"hardBreak"},{"type":"text","text":"Job: '"${JOB_NAME}"'"},
                                    {"type":"hardBreak"},{"type":"text","text":"Build: #'"${BUILD_NUMBER}"'"},
                                    {"type":"hardBreak"},{"type":"text","text":"Branch: '"${GIT_BRANCH_NAME:-main}"'"},
                                    {"type":"hardBreak"},{"type":"text","text":"URL: '"${BUILD_URL}"'"}]}]}}}')

                        HTTP_CODE=$(echo "$RESPONSE" | tail -1)
                        BODY=$(echo "$RESPONSE" | head -n -1)
                        if [ "$HTTP_CODE" = "201" ]; then
                            TICKET=$(echo "$BODY" | python3 -c "import sys,json; print(json.load(sys.stdin)['key'])" 2>/dev/null)
                            echo "âœ… Jira: ${TICKET} â†’ https://ron1120.atlassian.net/browse/${TICKET}"
                        else
                            echo "âš  Jira failed (HTTP ${HTTP_CODE}): $BODY"
                        fi
                    '''
                }
            }
        }
    }
}