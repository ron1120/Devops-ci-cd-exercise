# DevOps CI/CD Exercise

> A full end-to-end CI/CD pipeline built with Jenkins, Docker, Terraform, and Ansible â€” deploying a Flask application to AWS EC2.

---

## ğŸ“ Architecture Overview

![CI/CD Pipeline Architecture](./images/ci_cd_jenkins.png)
![Deployment Flow](./images/ci-cd2.png)

### High-Level Flow

```
Developer â†’ GitHub â†’ Jenkins CI â†’ Docker Hub â†’ Terraform + Ansible â†’ AWS EC2
    â”‚          â”‚          â”‚              â”‚               â”‚               â”‚
  Push      Webhook    Build &        Push           Provision       Deploy &
  Code      Trigger    Test           Image          Infra           Run App
```

---

## ğŸ—ï¸ Project Structure

```
.
â”œâ”€â”€ app/                          # Flask Application
â”‚   â”œâ”€â”€ __init__.py               #   App factory (create_app)
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ user_routes.py        #   /api/users endpoints (in-memory CRUD)
â”‚   â”‚   â””â”€â”€ product_routes.py     #   /api/products endpoints (in-memory CRUD)
â”‚   â””â”€â”€ templates/
â”‚       â””â”€â”€ index.html            #   Web UI
â”‚
â”œâ”€â”€ tests/                        # Test Suite
â”‚   â”œâ”€â”€ unit/                     #   Unit tests (routes, utils)
â”‚   â”œâ”€â”€ integration/              #   API integration tests
â”‚   â”œâ”€â”€ e2e/                      #   End-to-end (Selenium + headless Firefox)
â”‚   â””â”€â”€ performance/              #   Load tests (Locust)
â”‚
â”œâ”€â”€ jenkins/
â”‚   â””â”€â”€ Jenkinsfile               # Pipeline definition (11 stages)
â”‚
â”œâ”€â”€ docker/
â”‚   â”œâ”€â”€ Dockerfile                # Application container
â”‚   â”œâ”€â”€ Dockerfile.jenkins        # Custom Jenkins image with DevOps tools
â”‚   â”œâ”€â”€ plugins.txt               # Jenkins plugins list
â”‚   â””â”€â”€ casc/
â”‚       â””â”€â”€ jenkins.yaml          # Jenkins Configuration as Code
â”‚
â”œâ”€â”€ infrastructure/
â”‚   â”œâ”€â”€ terraform/                # Infrastructure as Code
â”‚   â”‚   â”œâ”€â”€ main.tf               #   AWS provider config
â”‚   â”‚   â”œâ”€â”€ variables.tf          #   Input variables (VPC reuse, EIP toggle, etc.)
â”‚   â”‚   â”œâ”€â”€ network.tf            #   Conditional VPC, Subnet, IGW, Route Table, SG
â”‚   â”‚   â”œâ”€â”€ ec2.tf                #   EC2 instance + optional EIP
â”‚   â”‚   â”œâ”€â”€ outputs.tf            #   IP, DNS, URLs, vpc_reused flag
â”‚   â”‚   â””â”€â”€ terraform.tfvars.example
â”‚   â””â”€â”€ ansible/
â”‚       â”œâ”€â”€ deploy.yml            #   Deployment playbook
â”‚       â”œâ”€â”€ ansible.cfg           #   Ansible configuration
â”‚       â””â”€â”€ inventory.ini         #   Dynamic inventory (generated by Jenkins)
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ destroy-staging.sh        # Tear down staging instances via AWS CLI
â”‚   â””â”€â”€ start-jenkins-locally.sh  # Local Jenkins startup helper
â”‚
â”œâ”€â”€ main.py                       # App entrypoint
â”œâ”€â”€ calc.py                       # Calculator module
â”œâ”€â”€ requirements.txt              # Python dependencies
â””â”€â”€ pytest.ini                    # Pytest configuration
```

---

## ğŸ”§ Tech Stack

| Layer | Technology | Purpose |
|-------|-----------|---------|
| **Application** | Python 3, Flask 2.3 | REST API + Web UI |
| **WSGI Server** | Gunicorn | Production-grade HTTP server |
| **CI/CD Engine** | Jenkins 2.x (LTS) | Pipeline orchestration |
| **Containerization** | Docker, Docker Buildx | App packaging (linux/amd64) |
| **Registry** | Docker Hub | Image storage & distribution |
| **Infrastructure** | Terraform â‰¥ 1.5 | AWS resource provisioning (conditional) |
| **Configuration Mgmt** | Ansible | Application deployment to EC2 |
| **Cloud** | AWS (us-east-2) | EC2, VPC, Subnet, IGW, SG |
| **Testing** | pytest, Selenium, Locust | Unit / Integration / E2E / Performance |
| **Security** | Bandit | Static security analysis |
| **Linting** | Flake8, Pylint | Code quality |
| **Notifications** | Email (SMTP), Jira REST API | Build alerts & ticket creation |
| **Version Control** | Git, GitHub | Source code management |

---

## ğŸš€ CI/CD Pipeline

### Pipeline Stages

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Checkout â”‚  Clone repo from GitHub
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Setup    â”‚  Create Python venv, install dependencies
â”‚     Env      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Lint     â”‚  Flake8 + Pylint static analysis
â”‚     Code     â”‚  â†’ HTML reports published to Jenkins sidebar
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Unit     â”‚  pytest + coverage (HTML, XML, terminal)
â”‚     Tests    â”‚  â†’ Coverage report published to Jenkins sidebar
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. Integration  â”‚  API endpoint testing with Flask test client
â”‚     Tests        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. E2E      â”‚  Selenium headless Firefox browser tests
â”‚     Tests    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. Security  â”‚  Bandit static security analysis
â”‚     Scan      â”‚  â†’ Report published to Jenkins sidebar
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8. Create       â”‚  CalVer tag: vYYYY.MM.DD.HHMMSS
â”‚     Version Tag  â”‚  (main/develop branches only)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  9. Build Docker â”‚  docker buildx --platform linux/amd64
â”‚     Image        â”‚  (main/develop branches only)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. Push Docker  â”‚  Push to Docker Hub (ronsss/devops-testing-app)
â”‚     Image        â”‚  (main/develop branches only)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  11. Deploy to Staging               â”‚
â”‚  (main/develop branches only)        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Terraform Init & Plan          â”‚  â”‚
â”‚  â”‚ Terraform Apply                â”‚  â”‚
â”‚  â”‚ Ansible Deploy                 â”‚  â”‚
â”‚  â”‚ Smoke Test (health + homepage) â”‚  â”‚
â”‚  â”‚ Performance Tests (Locust)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Jenkins Sidebar Reports

The following HTML reports are published and accessible from the Jenkins build sidebar:

| Report | Content |
|--------|---------|
| **Coverage Report** | pytest-cov HTML coverage (htmlcov/) |
| **Flake8 Report** | Flake8 style warnings |
| **Pylint Report** | Pylint code quality |
| **Performance Report** | Locust load test results |
| **Security Report (Bandit)** | Bandit static security scan |

### Branch-Based Behavior

| Branch | Tests | Docker Build & Push | Deploy to Staging | Performance Tests |
|--------|-------|---------------------|-------------------|-------------------|
| `main` | âœ… All | âœ… | âœ… | âœ… (on deployed EC2) |
| `develop` | âœ… All | âœ… | âœ… | âœ… (on deployed EC2) |
| Feature branches | âœ… All | âŒ Skip | âŒ Skip | âŒ Skip |

### Post-Build Actions

| Condition | Email | Jira Ticket | Priority |
|-----------|-------|-------------|----------|
| **Success** | âœ… Build summary | âŒ | â€” |
| **Unstable** (test failures) | âœ… With failure details | âœ… Task in KAN project | Medium |
| **Failure** (pipeline error) | âœ… With failed stage | âœ… Task in KAN project | High |

---

## â˜ï¸ AWS Infrastructure

### Conditional Resource Creation

Terraform **reuses existing resources** when they match by name/tag, and only creates what's missing. This prevents conflicts on re-runs:

| Resource | Lookup Method | Created If Missing |
|----------|---------------|-------------------|
| VPC | Tag `Name = staging-vpc` | âœ… |
| Subnet | Tag `Name = staging-public-subnet` in VPC | âœ… |
| Internet Gateway | Attached to VPC | âœ… |
| Route Table | Tag `Name = staging-public-rt` in VPC | âœ… |
| Security Group | Always created per apply | âœ… |
| EC2 Instance | Always created per apply | âœ… |
| Elastic IP | Controlled by `enable_eip` variable (default: off) | Optional |

### Resources Provisioned

```
AWS Region: us-east-2 (Ohio)
â”‚
â”œâ”€â”€ VPC (10.0.0.0/16) â€” reused if already exists
â”‚   â”œâ”€â”€ Public Subnet (10.0.1.0/24) â€” reused if already exists
â”‚   â”œâ”€â”€ Internet Gateway â€” reused if already exists
â”‚   â”œâ”€â”€ Route Table (0.0.0.0/0 â†’ IGW) â€” reused if already exists
â”‚   â””â”€â”€ Security Group
â”‚       â”œâ”€â”€ Inbound: SSH (22), HTTP (80), App (5000)
â”‚       â””â”€â”€ Outbound: All traffic
â”‚
â”œâ”€â”€ EC2 Instance
â”‚   â”œâ”€â”€ AMI: Amazon Linux 2023 (latest)
â”‚   â”œâ”€â”€ Type: t3.micro
â”‚   â”œâ”€â”€ Disk: 30 GB gp3 (encrypted)
â”‚   â”œâ”€â”€ Key: aws_key (ed25519)
â”‚   â””â”€â”€ User Data: Docker + Python3 installed at boot
â”‚
â””â”€â”€ Elastic IP (optional, off by default)
    â””â”€â”€ Controlled by var.enable_eip
```

### Ansible Deployment Flow

```
1. Wait for EC2 user_data to complete
2. Ensure Docker daemon is running
3. Login to Docker Hub
4. Pull application image
5. Stop & remove old container
6. Start new container (port 5000, restart: always)
7. Wait for health check (/health â†’ 200 OK)
```

---

## ğŸ³ Docker

### Application Image (`docker/Dockerfile`)

- **Base**: `python:3.11-slim`
- **Server**: Gunicorn (2 workers)
- **Port**: 5000
- **Health Check**: `curl http://localhost:5000/health`
- **Platform**: Built for `linux/amd64` (for AWS EC2 compatibility)

### Jenkins Image (`docker/Dockerfile.jenkins`)

Custom Jenkins image pre-loaded with:

| Tool | Purpose |
|------|---------|
| Python 3 + venv | Pipeline test execution |
| Docker CLI | Build & push images |
| Terraform 1.6.6 | Infrastructure provisioning |
| AWS CLI v2 | AWS API access |
| Ansible + boto3 | Application deployment |
| Firefox ESR + geckodriver | Selenium E2E tests (headless) |
| Jenkins plugins | Via `plugins.txt` |
| JCasC | Jenkins Configuration as Code |

### Running Jenkins Locally

```bash
# Build the custom Jenkins image
cd docker/
docker build -t jenkins-devops:latest -f Dockerfile.jenkins .

# Run Jenkins
docker run -d \
  --name jenkins \
  -p 8080:8080 \
  -p 50000:50000 \
  -v jenkins_home:/var/jenkins_home \
  -v /var/run/docker.sock:/var/run/docker.sock \
  jenkins-devops:latest
```

---

## ğŸ”‘ Jenkins Credentials

| ID | Type | Purpose |
|----|------|---------|
| `RonGitUser` | Username/Password | GitHub PAT |
| `RonDockerUser` | Username/Password | Docker Hub |
| `aws-credentials` | AWS Credentials | IAM Access Key + Secret |
| `StagingSSHKey` | SSH Private Key | EC2 SSH access (ec2-user) |
| `JIRA_API_TOKEN` | Secret Text | Jira REST API authentication |

---

## ğŸ§ª Testing

### Test Types

| Type | Location | Framework | Purpose |
|------|----------|-----------|---------|
| **Unit** | `tests/unit/` | pytest + pytest-cov | Route handlers, utilities |
| **Integration** | `tests/integration/` | pytest + Flask test client | Full API endpoint + workflow testing |
| **E2E** | `tests/e2e/` | Selenium + headless Firefox | Browser-based UI testing |
| **Performance** | `tests/performance/` | Locust | Load testing against deployed EC2 |

### Running Tests Locally

```bash
# Create virtual environment
python3 -m venv venv && source venv/bin/activate
pip install -r requirements.txt

# Run all tests
pytest tests/ -v

# Run with coverage
pytest tests/unit/ -v --cov=app --cov-report=html:htmlcov

# Run specific test suites
pytest tests/integration/ -v
pytest tests/e2e/ -v          # Requires Firefox + geckodriver
pytest tests/unit/ -v
```

### Performance Testing

Performance tests run **on the deployed EC2 instance** (not locally) during the Deploy to Staging stage:

```bash
# Run manually against a deployed instance
locust -f tests/performance/locustfile.py --headless \
    --users 10 --spawn-rate 2 --run-time 30s \
    --host http://<STAGING_IP>:5000 \
    --html reports/performance-report.html
```

---

## ğŸ“§ Notifications

### Email (SMTP)

- **Provider**: Gmail SMTP (`smtp.gmail.com:465`, SSL)
- **Recipient**: Configured in Jenkinsfile
- **Content**: HTML formatted with build number, branch, duration, status, and links

### Jira Integration

- **Instance**: `ron1120.atlassian.net`
- **Project**: KAN
- **Issue Type**: Task
- **Trigger**: Pipeline unstable (Medium priority) or failure (High priority)
- **Content**: Job name, build number, branch, build URL

---

## ğŸ› ï¸ Scripts

### `scripts/destroy-staging.sh`

Terminates staging EC2 instances directly via AWS CLI (no Terraform state required):

```bash
# Interactive confirmation
./scripts/destroy-staging.sh

# Skip confirmation
./scripts/destroy-staging.sh --force
```

- Finds instances by tag `Name = staging-app-server` in `us-east-2`
- Displays instance table before terminating
- Optionally cleans up associated security groups

### Destroy Production Environment

To tear down the staging environment, run:

```bash
./scripts/destroy-staging.sh
./scripts/destroy-staging.sh --force
```

---

## ğŸš¦ Quick Start

### 1. Run the App Locally

```bash
python3 -m venv venv && source venv/bin/activate
pip install -r requirements.txt
python main.py
# App available at http://localhost:5000
```

### 2. Run with Docker

```bash
docker build -t devops-testing-app -f docker/Dockerfile .
docker run -p 5000:5000 devops-testing-app
# App available at http://localhost:5000
```

### 3. API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/` | Web UI (HTML page) |
| GET | `/health` | Health check (`{ "status": "healthy" }`) |
| GET | `/api/users/` | List all users |
| GET | `/api/users/<id>` | Get user by ID |
| POST | `/api/users/` | Create a user (`name`, `email` required) |
| GET | `/api/products/` | List all products |
| GET | `/api/products/<id>` | Get product by ID |
| POST | `/api/products/` | Create a product (`name`, `price` required) |
| PUT | `/api/products/<id>` | Update a product |
